<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>krymtkts: F#で PowerShell コマンドレットを書き始めた</title>
    <link rel="canonical" href="https://krymtkts.github.io/posts/2022-05-07-start-to-write-cmdlet-by-fsharp">
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <meta name="description" content="krymtkts&#39;s personal blog">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="krymtkts&#39;s personal blog" />
    <meta property="og:site_name" content="krymtkts" />
    <meta property="og:title" content="krymtkts: F#で PowerShell コマンドレットを書き始めた" />
    <meta property="og:url" content="https://krymtkts.github.io/posts/2022-05-07-start-to-write-cmdlet-by-fsharp" />
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/solarized-dark.min.css" integrity="sha256-90Y+fvi28WF+3jKH4tHEkoQ9WLeFKJjpvCPNOtU9ZvU=" crossorigin="anonymous" />
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">krymtkts</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives">Archives</a></li>
                
                <li
                >
                <a href="/pages/about">About Me</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        

                        
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a href="/posts/2022-07-03-aws-cdk-with-fsharp">F# で AWS CDK して躓いてる</a></li>
                        
                        <li><a href="/posts/2022-06-26-writing-cmdlet-in-fsharp-pt3">F#でコマンドレットを書いてる pt.3</a></li>
                        
                        <li><a href="/posts/2022-06-19-belatedly-parallel-foreach-object">今更 ForEach-Object -Parallel</a></li>
                        
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a href="/tags/biasamp">biasamp</a></li>
                        
                        <li><a href="/tags/poco">poco</a></li>
                        
                        <li><a href="/tags/tips">tips</a></li>
                        
                        <li><a href="/tags/evernote">evernote</a></li>
                        
                        <li><a href="/tags/qunit">qunit</a></li>
                        
                        <li><a href="/tags/cryogen">cryogen</a></li>
                        
                        <li><a href="/tags/mouse">mouse</a></li>
                        
                        <li><a href="/tags/nyc">nyc</a></li>
                        
                        <li><a href="/tags/diary">diary</a></li>
                        
                        <li><a href="/tags/github">github</a></li>
                        
                        <li><a href="/tags/clojure">clojure</a></li>
                        
                        <li><a href="/tags/vscode">vscode</a></li>
                        
                        <li><a href="/tags/stepfunctions">stepfunctions</a></li>
                        
                        <li><a href="/tags/aws">aws</a></li>
                        
                        <li><a href="/tags/shieldsio">shieldsio</a></li>
                        
                        <li><a href="/tags/retrospective">retrospective</a></li>
                        
                        <li><a href="/tags/boto3">boto3</a></li>
                        
                        <li><a href="/tags/job">job</a></li>
                        
                        <li><a href="/tags/oh-my-posh">oh-my-posh</a></li>
                        
                        <li><a href="/tags/elm">elm</a></li>
                        
                        <li><a href="/tags/elb">elb</a></li>
                        
                        <li><a href="/tags/openssh">openssh</a></li>
                        
                        <li><a href="/tags/powershell">powershell</a></li>
                        
                        <li><a href="/tags/gist">gist</a></li>
                        
                        <li><a href="/tags/planck">planck</a></li>
                        
                        <li><a href="/tags/acm">acm</a></li>
                        
                        <li><a href="/tags/php">php</a></li>
                        
                        <li><a href="/tags/go">go</a></li>
                        
                        <li><a href="/tags/mechanicalkeyboard">mechanicalkeyboard</a></li>
                        
                        <li><a href="/tags/pandoc">pandoc</a></li>
                        
                        <li><a href="/tags/fsharp">fsharp</a></li>
                        
                        <li><a href="/tags/windows">windows</a></li>
                        
                        <li><a href="/tags/maven">maven</a></li>
                        
                        <li><a href="/tags/font">font</a></li>
                        
                        <li><a href="/tags/git">git</a></li>
                        
                        <li><a href="/tags/docker">docker</a></li>
                        
                        <li><a href="/tags/todo">todo</a></li>
                        
                        <li><a href="/tags/sh">sh</a></li>
                        
                        <li><a href="/tags/cement">cement</a></li>
                        
                        <li><a href="/tags/psake">psake</a></li>
                        
                        <li><a href="/tags/textlin">textlin</a></li>
                        
                        <li><a href="/tags/python">python</a></li>
                        
                        <li><a href="/tags/golang">golang</a></li>
                        
                        <li><a href="/tags/fnm">fnm</a></li>
                        
                        <li><a href="/tags/lambda">lambda</a></li>
                        
                        <li><a href="/tags/tortoisegit">tortoisegit</a></li>
                        
                        <li><a href="/tags/docker-toolbox">docker-toolbox</a></li>
                        
                        <li><a href="/tags/serverless">serverless</a></li>
                        
                        <li><a href="/tags/qmkfirmware">qmkfirmware</a></li>
                        
                        <li><a href="/tags/nodejs">nodejs</a></li>
                        
                        <li><a href="/tags/goal">goal</a></li>
                        
                        <li><a href="/tags/powershellgallery">powershellgallery</a></li>
                        
                        <li><a href="/tags/puppeteer">puppeteer</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">2022-05-07</div>
        
    </div>
    <h2>F#で PowerShell コマンドレットを書き始めた</h2>
</div>
<div>
    
    <p>勉強がてら、F# で PowerShell のコマンドレットを書きはじめる。
↓ を参考にやる。ただし .NET 6.0 を対象にする。</p><p><a href="https://webcoder.info/fspsmodule.html">Writing a PowerShell Core Module With F#, A Complete Guide | Brianary</a></p><p>初めての要素が多いので、ゆっくり進める。</p><ul><li>F# でアプリ書くのが初</li><li>コマンドレットを書くのが初</li><li>dotnet CLI を使った開発が初</li><li>その他 PowerShell 系のツール(<a href="https://github.com/pester/Pester">Pester</a>,<a href="https://github.com/PowerShell/platyPS">platyPS</a>)をちゃんと使うのが初
<ul><li>参考にする記事にはないが、ビルドスクリプトも <a href="https://github.com/psake/psake">psake</a> で書く</li></ul></li></ul><p>題材としては、<a href="https://github.com/jasonmarcher/poco">poco</a> の再実装をしてみるつもり。</p><p>諸々のツールが出てくるので一覧しておく。</p><ul><li>GitHub の Repo の作成に <a href="https://github.com/microsoft/PowerShellForGitHub">PowerShellForGitHub</a></li><li>remote repo の管理に <a href="https://github.com/x-motemen/ghq">ghq</a></li><li>コミット署名のために <a href="https://community.chocolatey.org/packages/Gpg4win">Gpg4win</a></li></ul><h3 id="repo-とプロジェクトを作成する">repo とプロジェクトを作成する</h3><p>動くものになるまでは private repo で運用する。動かないなら公開しても意味がないからね。</p><pre><code class="powershell"># private repo を作成する。
$owner = 'krymtkts'
$module = 'pocof'
New-GitHubRepository -RepositoryName 'pocof' -Private

# remote repo を clone する。
ghq get -p (Get-GitHubRepository -OwnerName $owner -RepositoryName $module | Select-Object -ExpandProperty ssh_url)
cd "$(ghq root)/$(ghq list $module)"

# initial commit を刻む。
gpg-connect-agent reloadagent /bye # &lt;- gpg-agent が立ち上がってこないので先に起こす。
git commit --allow-empty -m 'Initial commit.'
dotnet new sln

# 空のプロジェクトを作成。
dotnet new classlib --language 'F#' --framework net6.0 -o src/$module
dotnet sln add src/$module/$module.fsproj
cd src/$module
# PowerShell 開発の依存関係を追加。
dotnet add package PowerShellStandard.Library
New-ModuleManifest "$module.psd1"
'&lt;helpItems schema="maml" xmlns="http://msh" /&gt;' | Set-Content "$module.dll-Help.xml" -Encoding utf8
</code></pre><p>これで repo と空の F# プロジェクト <code>pocof.fsproj</code> ができた。
次に、記事に記載の通り、 <code>pocof.fsproj</code> に必要な情報を加筆する。</p><ul><li><code>PropertyGroup</code> に <code>Version</code> 属性を追加</li><li><code>ItemGroup</code> 属性を追加して、コピーするファイルを記載する</li></ul><p>また PowerShell のモジュール情報を <code>pocof.psd1</code> 書き込む。
コマンドレットなので、 <code>RootModule</code> を書き忘れるとコマンドがインポートできないのでご注意(書き忘れてて <code>Import-Module</code> しても使えない！となった)。</p><p>あと作成後に気づいたのだが、 作成された <code>*.sln</code> 等のエンコーディングが UTF8 with BOM だったり改行が CRLF だったりするので、それらを UTF8 と LF に手で補正した。</p><p>最後に 空の XML-based help file を作成しているが、これは <code>Get-Help</code> で使うヘルプファイルで、後で PlatyPS で上書きされるやつ。
<a href="https://docs.microsoft.com/en-us/powershell/scripting/developer/help/naming-help-files?view=powershell-7.2">Naming Help Files - PowerShell | Microsoft Docs</a></p><h3 id="f-開発環境を準備する">F# 開発環境を準備する</h3><p>わたしは VS Code を使っているので、F# 用の拡張機能を入れる。</p><ul><li><a href="https://marketplace.visualstudio.com/items?itemName=Ionide.Ionide-fsharp">Ionide for F# - Visual Studio Marketplace</a></li></ul><p>F# でフォーマッタといえば <code>fantomas</code> のようなのだけど、個別に入れなくても Ionide がうまく拾えるらしい。 <a href="https://github.com/ionide/ionide-vscode-fsharp/issues/1346">Formatting Settings · Issue #1346 · ionide/ionide-vscode-fsharp</a></p><h3 id="コードを編集する">コードを編集する</h3><p>自動生成されたコードを編集する。
記事に記載のものだとパラメータに <code>Position</code> がなくて Pester こけそうなのと、自分のやりたいことに合わせた引数を書くなど諸々の調整をする。</p><p>Pester のテストコードも作成する。テストコードは <code>tests</code> ディレクトリ配下に配置した。</p><h3 id="ビルドテスト実行">ビルド＆テスト実行</h3><p>記事に記載の通りだと typo があったり <code>Import-Module</code> 前に削除があって消えてしまう等ある。
編集して実行した。</p><pre><code class="powershell">$ModuleName = Resolve-Path ./src/* | Split-Path -Leaf
Import-LocalizedData -BindingVariable module -BaseDirectory (Resolve-Path ./src/*) -FileName "$ModuleName.psd1"
if ($module.ModuleVersion -ne (Resolve-Path ./src/*/*.fsproj | Select-Xml '//Version/text()').Node.Value) {
    throw 'Module manifest (.psd1) version does not match project (.fsproj) version.'
}
dotnet publish
cp (Resolve-Path ./src/*/bin/Debug/*/publish/FSharp.Core.dll) (Resolve-Path ./src/*/bin/Debug/*/) -Verbose

# import して Pester 実行。
# モジュールのバージョンであったり export される Cmdlet が正しいかなど見る。
Import-Module (Resolve-Path ./src/*/bin/Debug/*/publish/*.psd1) -Force
Invoke-Pester
</code></pre><p>あとこれらを <code>psake</code> で実行できるように <code>psakefile.ps1</code> に記載した。</p><p>F# のプロジェクトだったら <a href="https://github.com/fsprojects/FAKE">FAKE</a> を使った方がいいのかなーと考えていた。となると、依存する <a href="https://fsprojects.github.io/Paket/">Paket</a> も入れないといけない。いま <code>dotnet</code> CLI で管理してたのでいらないかなーと思った。
また、今回作りたいのは PowerShell のコマンドレットなので、 周辺のツールも PowerShell だ。これをいちいち <code>fake.cmd</code> や <code>dotnet fake build</code>を介して実行するのなんかダルいな...と億劫だったので、 FAKE の導入は見送ることにした。</p><h3 id="ドキュメントを生成する">ドキュメントを生成する</h3><p>記事では <a href="https://github.com/PowerShell/platyPS">platyPS</a> を使っているのでそれに従う。</p><pre><code class="powershell"># 事前にビルドしたモジュールを Import-Module しておく。
New-MarkdownHelp -Module pocof -OutputFolder ./docs -ErrorAction SilentlyContinue
# dll-Help.xml を作るときに実行する。
New-ExternalHelp docs -OutputPath (Resolve-Path ./src/*/) -Force
</code></pre><p>コメントに記した通り、他のタスクと依存関係にある。こういうのは <code>psakefile.ps1</code> にまとめる。</p><p>ヘルプの作成元は Markdown をオリジナルとする方針。</p><h3 id="powershell-gallery-へのリリース">PowerShell Gallery へのリリース</h3><p>まだやらないけど手順だけ確立しておく。</p><p>記事に記載のものだと、ビルドコンフィグレーションを Release にして Import、その後 Import したモジュールを公開、という手順になっている。</p><p>個人的にやったことがあるのはフォルダを指定して公開する方だけなので、どっちにするかなーと悩んでいる。間違って古い Import 済みモジュールを公開するミスとかないのかな、というのが疑問。</p><p>ま、勉強のためのものであるし、やったことない方を接客的に選んでみるのも一興か。コマンドレットが正しくエクスポートできているか、リリース前にテストするにもこの方法を取るのが良さそうだし。</p><p>とはいえ記事に記載の通りやると、自分が普段利用している PowerShell Module のパスに直でリリース前のモジュールを打ち込んでしまう。
これはちょっと実用始めたら困りそうなので、ディレクトリを変える必要がある。
となると結局いつものパス指定でのリリース方式でええんちゃうか...</p><p>いずれを選択するかはまた検討したい。</p><p>また、これらのリリースタスクも <code>psakefile.ps1</code> に定義するものとする。</p><h3 id="おわりに">おわりに</h3><p>これでひとまず準備完了。
ほぼ記事に記載のとおりやってきたけど、ちょいちょい自分用に変えたり、新しい要素については色々調べながらやってるので、進捗は亀のスピードだった。
動くものをこしらえれたら public repo にしよう。</p><p>現時点で不足しているとわかっている点もある。
今回書きたいコマンドレットはインタラクティブなものなので、きっと Pester でテストできない点が出てくる。
それらは <a href="https://fsprojects.github.io/FsUnit/">FsUnit</a> を使って可能な限りテストを書きたい所存。</p><p>あと困っているのが、参考にしている記事にも記載があったが、 DLL への参照が切れなくてファイルを消したりできなくなる(<code>Remove-Module</code> 忘れとかでなく)。いまは都度 PowerShell のセッションを作り直してるけど相当に面倒なので、原因を突き止めてどうにかしたいな。</p><p>未経験のものに触れるのは普段得られない刺激があって良い。</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/powershell">powershell</a>
    
    <a href="/tags/fsharp">fsharp</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts/2022-05-14-think-about-alignment-of-full-width-chars">&laquo; 2022-05-14 East Asian な全角文字をキーに使った場合のアラインメントについて考える</a>
        
        
        <a class="right" href="/posts/2022-04-29-good-bye-omp-module">2022-04-29 さよなら oh-my-posh モジュール &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2019-2022 krymtkts
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
