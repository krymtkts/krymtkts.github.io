<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>krymtkts: PoweShell で半角スペース(U+0020) -eq 全角スペース(U+3000) が True となる</title>
    <link rel="canonical" href="https://krymtkts.github.io/posts/2022-06-05-whitespace-comparison-in-pwsh">
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <meta name="description" content="krymtkts&#39;s personal blog">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="krymtkts&#39;s personal blog" />
    <meta property="og:site_name" content="krymtkts" />
    <meta property="og:title" content="krymtkts: PoweShell で半角スペース(U+0020) -eq 全角スペース(U+3000) が True となる" />
    <meta property="og:url" content="https://krymtkts.github.io/posts/2022-06-05-whitespace-comparison-in-pwsh" />
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/solarized-dark.min.css" integrity="sha256-90Y+fvi28WF+3jKH4tHEkoQ9WLeFKJjpvCPNOtU9ZvU=" crossorigin="anonymous" />
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">krymtkts</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives">Archives</a></li>
                
                <li
                >
                <a href="/pages/about">About Me</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        

                        
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a href="/posts/2022-08-07-git-says-the-local-repo-is-not-yours">git で local repo が自分のものじゃないとなったやつ</a></li>
                        
                        <li><a href="/posts/2022-08-06-usecase-of-get-gzipcontent">Get-GzipContent のユースケース</a></li>
                        
                        <li><a href="/posts/2022-07-30-practice-build-aws-tools-for-powrshell">AWS Tools for PowerShell のビルド素振り</a></li>
                        
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a href="/tags/biasamp">biasamp</a></li>
                        
                        <li><a href="/tags/poco">poco</a></li>
                        
                        <li><a href="/tags/tips">tips</a></li>
                        
                        <li><a href="/tags/evernote">evernote</a></li>
                        
                        <li><a href="/tags/qunit">qunit</a></li>
                        
                        <li><a href="/tags/cryogen">cryogen</a></li>
                        
                        <li><a href="/tags/mouse">mouse</a></li>
                        
                        <li><a href="/tags/nyc">nyc</a></li>
                        
                        <li><a href="/tags/diary">diary</a></li>
                        
                        <li><a href="/tags/github">github</a></li>
                        
                        <li><a href="/tags/clojure">clojure</a></li>
                        
                        <li><a href="/tags/vscode">vscode</a></li>
                        
                        <li><a href="/tags/stepfunctions">stepfunctions</a></li>
                        
                        <li><a href="/tags/aws">aws</a></li>
                        
                        <li><a href="/tags/shieldsio">shieldsio</a></li>
                        
                        <li><a href="/tags/retrospective">retrospective</a></li>
                        
                        <li><a href="/tags/boto3">boto3</a></li>
                        
                        <li><a href="/tags/job">job</a></li>
                        
                        <li><a href="/tags/oh-my-posh">oh-my-posh</a></li>
                        
                        <li><a href="/tags/elm">elm</a></li>
                        
                        <li><a href="/tags/elb">elb</a></li>
                        
                        <li><a href="/tags/openssh">openssh</a></li>
                        
                        <li><a href="/tags/powershell">powershell</a></li>
                        
                        <li><a href="/tags/gist">gist</a></li>
                        
                        <li><a href="/tags/planck">planck</a></li>
                        
                        <li><a href="/tags/acm">acm</a></li>
                        
                        <li><a href="/tags/php">php</a></li>
                        
                        <li><a href="/tags/go">go</a></li>
                        
                        <li><a href="/tags/mechanicalkeyboard">mechanicalkeyboard</a></li>
                        
                        <li><a href="/tags/pandoc">pandoc</a></li>
                        
                        <li><a href="/tags/fsharp">fsharp</a></li>
                        
                        <li><a href="/tags/windows">windows</a></li>
                        
                        <li><a href="/tags/maven">maven</a></li>
                        
                        <li><a href="/tags/font">font</a></li>
                        
                        <li><a href="/tags/git">git</a></li>
                        
                        <li><a href="/tags/docker">docker</a></li>
                        
                        <li><a href="/tags/todo">todo</a></li>
                        
                        <li><a href="/tags/sh">sh</a></li>
                        
                        <li><a href="/tags/cement">cement</a></li>
                        
                        <li><a href="/tags/psake">psake</a></li>
                        
                        <li><a href="/tags/textlin">textlin</a></li>
                        
                        <li><a href="/tags/python">python</a></li>
                        
                        <li><a href="/tags/golang">golang</a></li>
                        
                        <li><a href="/tags/fnm">fnm</a></li>
                        
                        <li><a href="/tags/lambda">lambda</a></li>
                        
                        <li><a href="/tags/tortoisegit">tortoisegit</a></li>
                        
                        <li><a href="/tags/docker-toolbox">docker-toolbox</a></li>
                        
                        <li><a href="/tags/serverless">serverless</a></li>
                        
                        <li><a href="/tags/qmkfirmware">qmkfirmware</a></li>
                        
                        <li><a href="/tags/nodejs">nodejs</a></li>
                        
                        <li><a href="/tags/goal">goal</a></li>
                        
                        <li><a href="/tags/powershellgallery">powershellgallery</a></li>
                        
                        <li><a href="/tags/puppeteer">puppeteer</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">2022-06-05</div>
        
    </div>
    <h2>PoweShell で半角スペース(U+0020) -eq 全角スペース(U+3000) が True となる</h2>
</div>
<div>
    
    <p>転職して 3 ヶ月目を迎えた。
入社以降は何の因果か CRM の導入をやることになり、既存データ(スプレッドシート)の以降のために PowerShell を駆使している。</p><p>そんな中で今まで知らなかった PowerShell の表情をいくつも知ることができ(例えばコレとか)、なんやかんやで楽しんでいる。</p><p>その中で度肝を抜かれたのが、今日のテーマ。</p><p><code>' '</code>(U+0020) <code>-eq</code> <code>' '</code>(U+3000) が <code>True</code> となる。</p><p>PowerShell 7 と Windows PowerShell 5.1 で試した。</p><pre><code class="plaintext">Name                           Value
----                           -----
PSVersion                      7.2.4
PSEdition                      Core
GitCommitId                    7.2.4
OS                             Microsoft Windows 10.0.22000
Platform                       Win32NT
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0…}
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
WSManStackVersion              3.0
</code></pre><pre><code class="plaintext">Name                           Value
----                           -----
PSVersion                      5.1.22000.653
PSEdition                      Desktop
PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}
BuildVersion                   10.0.22000.653
CLRVersion                     4.0.30319.42000
WSManStackVersion              3.0
PSRemotingProtocolVersion      2.3
SerializationVersion           1.1.0.1
</code></pre><p>7 だと <code>True</code> 、 5.1 だと <code>False</code> だ。
<code>-ceq</code> だと 7 でも <code>False</code> を返すので <code>-ieq</code> の判定が違うのだけど、 PowerShell Core からこうなんだろうか？
PowerShell の実装を追ってみたが、追いきれなかった。 めちゃくちゃ<a href="https://github.com/PowerShell/PowerShell/blob/87f621eb1fa94f1d114b0cc4a5fb7aab5d3133c9/src/System.Management.Automation/engine/parser/Compiler.cs#L5804%E3%83%BCL5806">ココ</a>っぽいのだけど、 LINQ に由来するクラス <a href="https://docs.microsoft.com/en-us/dotnet/api/system.linq.expressions.dynamicexpression.dynamic?view=net-6.0#system-linq-expressions-dynamicexpression-dynamic(system-runtime-compilerservices-callsitebinder-system-type-system-linq-expressions-expression-system-linq-expressions-expression)">DynamicExpression</a> とかの知識がないのでまだ調査中。</p><p>どう説明したらいいか悩むのが、いくつか試してみていてわかってきたのは、 <code>String</code> の <code>-ieq</code> でこの事象が見られること。 <code>Char</code> だと起こらない。</p><pre><code class="powershell">' ' -ieq '　' # True
([char][int]'0x20') -ieq ([char][int]'0x3000')  # Char だと False
([string][char][int]'0x20') -ieq ([string][char][int]'0x3000') # String だと True
</code></pre><p>そしてもう 1 つ、 Unicode で General category が Separator, space と定義されているものが等値と判定されること。</p><p><a href="https://en.wikipedia.org/wiki/Whitespace_character#Unicode">Whitespace character - Wikipedia</a> の表が非常にわかりやすい。ここから以下のテストコードを作成し、先述の事実を導いた。</p><pre><code class="powershell">'0x0009', '0x000A', '0x000B', '0x000C', '0x000D', '0x0020', '0x0085', '0x00A0', '0x1680', '0x2000', '0x2001', '0x2002', '0x2003', '0x2004', '0x2005', '0x2006', '0x2007', '0x2008', '0x2009', '0x200A', '0x2028', '0x2029', '0x202F', '0x205F', '0x3000' | % { [PSCustomObject]@{
    CodePoint = $_
    isEquals = ([string][char][int]$_) -eq ' '
}}
</code></pre><pre><code class="plaintext">CodePoint isEquals
--------- --------
0x0009       False
0x000A       False
0x000B       False
0x000C       False
0x000D       False
0x0020        True
0x0085       False
0x00A0        True
0x1680        True
0x2000        True
0x2001        True
0x2002        True
0x2003        True
0x2004        True
0x2005        True
0x2006        True
0x2007        True
0x2008        True
0x2009        True
0x200A        True
0x2028       False
0x2029       False
0x202F        True
0x205F        True
0x3000        True
</code></pre><p>あーココまで来ると、意図的な挙動 ≒ 仕様というのに当たりがつく。
なので .NET の String クラスの挙動を見てみると...</p><pre><code class="powershell">' '.Equals('　', [StringComparison]::CurrentCultureIgnoreCase) # True

'0x0009', '0x000A', '0x000B', '0x000C', '0x000D', '0x0020', '0x0085', '0x00A0', '0x1680', '0x2000', '0x2001', '0x2002', '0x2003', '0x2004', '0x2005', '0x2006', '0x2007', '0x2008', '0x2009', '0x200A', '0x2028', '0x2029', '0x202F', '0x205F', '0x3000' | % { [PSCustomObject]@{
&gt;     CodePoint = $_
&gt;     isEquals = ([string][char][int]$_).Equals(' ', [StringComparison]::CurrentCultureIgnoreCase)
&gt; }}
</code></pre><pre><code class="plaintext">CodePoint isEquals
--------- --------
0x0009       False
0x000A       False
0x000B       False
0x000C       False
0x000D       False
0x0020        True
0x0085       False
0x00A0        True
0x1680        True
0x2000        True
0x2001        True
0x2002        True
0x2003        True
0x2004        True
0x2005        True
0x2006        True
0x2007        True
0x2008        True
0x2009        True
0x200A        True
0x2028       False
0x2029       False
0x202F        True
0x205F        True
0x3000        True
</code></pre><p><code>StringComparison.InvariantCultureIgnoreCase</code> は同じ結果。 <code>StringComparison.OrdinalIgnoreCase</code> は違う結果となった。</p><p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.stringcomparison?view=net-6.0">StringComparison Enum (System) | Microsoft Docs</a></p><p>全然知らんかった...また世の中に恥を晒してしまったと共に、1 つ学んだわ。
まだ確かな情報源を得たわけじゃないけど、きっと世の中のﾄﾞｯﾄﾈｯﾀｰにとっては常識なんやろなあ。
手始めに ↓ コレちゃんと読むようにしよう...</p><p><a href="https://docs.microsoft.com/en-us/dotnet/standard/base-types/best-practices-strings">Best Practices for Comparing Strings in .NET | Microsoft Docs</a></p><hr /><p>ちなみにこの調査において、 <code>-like</code> には <code>System.Management.Automation.WildcardPattern</code> が使われていて、しかも公開されてるクラスというのがわかった。こんなのがあるの知らなかったわ。</p><p>そのまま <a href="https://github.com/krymtkts/pocof#readme">pocof</a> のワイルドカード検索で利用することにした。↓ こういう使い方。</p><pre><code class="powershell">([System.Management.Automation.WildcardPattern]"*ui*").IsMatch('kouiuno')
</code></pre>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/powershell">powershell</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts/2022-06-12-writing-cmdlet-in-fsharp-pt2">&laquo; 2022-06-12 F#でコマンドレットを書いてる pt.2</a>
        
        
        <a class="right" href="/posts/2022-05-28-writing-cmdlet-in-fsharp">2022-05-28 F#でコマンドレットを書いてる &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2019-2022 krymtkts
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
