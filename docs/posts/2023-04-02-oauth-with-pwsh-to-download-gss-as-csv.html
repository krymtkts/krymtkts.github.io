<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>krymtkts: PowerShell で OAuth して Google Sheet を CSV で DL する</title>
    <link rel="canonical" href="https://krymtkts.github.io/posts/2023-04-02-oauth-with-pwsh-to-download-gss-as-csv">
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <meta name="description" content="krymtkts&#39;s personal blog">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="krymtkts&#39;s personal blog" />
    <meta property="og:site_name" content="krymtkts" />
    <meta property="og:title" content="krymtkts: PowerShell で OAuth して Google Sheet を CSV で DL する" />
    <meta property="og:url" content="https://krymtkts.github.io/posts/2023-04-02-oauth-with-pwsh-to-download-gss-as-csv" />
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/css/bootstrap.min.css" integrity="sha512-XWTTruHZEYJsxV3W/lSXG1n3Q39YIWOstqvmFsdNEEQfHoZ6vm6E9GK2OrF6DSJSpIbRbi+Nn0WDPID9O7xB2Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/fontawesome.min.css" integrity="sha512-R+xPS2VPCAFvLRy+I4PgbwkWjw1z5B5gNDYgJN5LfzV4gGNeRQyVrY7Uk59rX+c8tzz63j8DeZPLqmXvBxj8pA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/base16/solarized-dark.min.css" integrity="sha512-kBHeOXtsKtA97/1O3ebZzWRIwiWEOmdrylPrOo3D2+pGhq1m+1CroSOVErIlsqn1xmYowKfQNVDhsczIzeLpmg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-expand-lg navbar-default">
    <div class="container">
        <div class="navbar-header d-flex w-100 justify-content-between">
            <a class="navbar-brand" href="/">krymtkts</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a  class="nav-link "  href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a  class="nav-link "  href="/archives">Archives</a>
                </li>
                
                <li class="nav-item">
                    <a  class="nav-link "  href="/pages/about">About Me</a>
                </li>
                
                <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" id="dropdown-menu-link" data-bs-toggle="dropdown" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-menu-link">
                        

                        
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a class="dropdown-item" href="/posts/2023-09-24-rebuild-blog-with-fable-pt14">Fable でブログを再構築する pt.14</a></li>
                        
                        <li><a class="dropdown-item" href="/posts/2023-09-17-rebuild-blog-with-fable-pt13">Fable でブログを再構築する pt.13</a></li>
                        
                        <li><a class="dropdown-item" href="/posts/2023-09-10-rebuild-blog-with-fable-pt12">Fable でブログを再構築する pt.12</a></li>
                        
                        

                        
                        <li><hr class="dropdown-divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a class="dropdown-item" href="/tags/biasamp">biasamp</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/poco">poco</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/windows-terminal">windows-terminal</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/tips">tips</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/evernote">evernote</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/qunit">qunit</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/cryogen">cryogen</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/mouse">mouse</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/nyc">nyc</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/ouraring">ouraring</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/diary">diary</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/github">github</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/clojure">clojure</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/vscode">vscode</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/stepfunctions">stepfunctions</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/aws">aws</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/shieldsio">shieldsio</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/retrospective">retrospective</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/boto3">boto3</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/job">job</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/bulma">bulma</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/oh-my-posh">oh-my-posh</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/elm">elm</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/elb">elb</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/openssh">openssh</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/electron">electron</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/powershell">powershell</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/gist">gist</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/planck">planck</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/acm">acm</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/fable">fable</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/php">php</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/go">go</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/mechanicalkeyboard">mechanicalkeyboard</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/pandoc">pandoc</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/fsharp">fsharp</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/cvs2git">cvs2git</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/windows">windows</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/maven">maven</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/font">font</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/git">git</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/docker">docker</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/todo">todo</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/sh">sh</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/cement">cement</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/psake">psake</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/textlin">textlin</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/python">python</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/golang">golang</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/fnm">fnm</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/lambda">lambda</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/tortoisegit">tortoisegit</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/docker-toolbox">docker-toolbox</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/serverless">serverless</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/qmkfirmware">qmkfirmware</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/razer">razer</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/nodejs">nodejs</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/goal">goal</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/powershellgallery">powershellgallery</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/puppeteer">puppeteer</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">2023-04-02</div>
        
    </div>
    <h2>PowerShell で OAuth して Google Sheet を CSV で DL する</h2>
</div>
<div>
    
    <p>最近役目を終えたスクリプトに、 Google Sheet を CSV でダウンロードするやつがいた。考慮不足等、諸々至らぬ点あろうが、スクリプトを供養するため日記にする。</p><p>モジュール導入したくないなーという事情があったので、下記を見てヒイヒイ言いながら実装した記憶がある。
「Google Sheet から CSV をダウンロードする」には <code>https://www.googleapis.com/auth/drive</code> のスコープがいるみたい。てっきりスプシのスコープと勘違いして、無駄に時間かかった。</p><ul><li><a href="https://stackoverflow.com/questions/63125283/how-to-connect-api-from-powershell-with-oauth-2-0">How to connect API from PowerShell with OAUTH 2.0? - Stack Overflow</a></li><li><a href="https://lazyadmin.nl/it/connect-to-google-api-with-powershell/">Connect to Google API with Powershell — LazyAdmin</a> して - <a href="https://stackoverflow.com/questions/37705553/how-to-export-a-csv-from-google-sheet-api/61107170#61107170">r googlesheets - How to export a csv from Google Sheet API? - Stack Overflow</a> する</li></ul><p>スクリプトは Gist に登録しておいた。
それに伴い Comment-Based Help を書いたり、関数の名前を変えたりした。Google Sheets ってサービス名に対してスプシ自体は spreadsheet だったりしてマジでややこしい。</p><p><a href="https://gist.github.com/krymtkts/0618fe495df0d3e567e9fb18ca2e308b">GoogleSpreadSheetOAuth.ps1</a></p><pre><code class="powershell">&lt;#
.SYNOPSIS
Download Google Sheet as CSV.
.DESCRIPTION
Download Google Sheet as CSV using GCP OAuth Client.
.PARAMETER OAuthClientSecretsPath
The path to the JSON file for the OAuth 2.0 Client Secrets created on GCP.
.PARAMETER OAuthStorePath
The path to save authentication tokens.
.EXAMPLE
. ./GoogleSheetsOAuth.ps1 `
    -OAuthClientSecretsPath './client-secrets.json' `
    -OAuthStorePath './gss-credential'
Get-GoogleSpreadSheetAsCsv `
    -SpreadSheet 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' `
    -SheetId '000000000' `
    -OutFile './test.csv'
#&gt;
[CmdletBinding()]
param (
    [Parameter(Mandatory)]
    [string]
    $OAuthClientSecretsPath,
    [Parameter(Mandatory)]
    [string]
    $OAuthStorePath
)

class OAuthCredentialStore {
    [SecureString] $AccessToken
    [SecureString] $RefreshToken
    OAuthCredentialStore(
        [SecureString] $AccessToken,
        [SecureString] $RefreshToken
    ) {
        $this.AccessToken = $AccessToken
        $this.RefreshToken = $RefreshToken
    }
}

$script:OAuthCredential = $null

function Get-GoogleSheetsAuthInitToken {
    [CmdletBinding(SupportsShouldProcess)]
    param ()

    if (-not (Split-Path $OAuthStorePath -Parent | Test-Path)) {
        throw "${OAuthStorePath} not found."
    }

    if (-not (Test-Path $OAuthClientSecretsPath)) {
        throw "${OAuthClientSecretsPath} not found."
    }
    $secrets = Get-Content $OAuthClientSecretsPath | ConvertFrom-Json | Select-Object -ExpandProperty installed

    $Scope = [System.Web.HttpUtility]::UrlEncode('https://www.googleapis.com/auth/drive')
    $ClientID = $secrets.client_id
    $ClientSecret = $secrets.client_secret
    $RedirectUri = $secrets.redirect_uris[0]
    $Uri = "https://accounts.google.com/o/oauth2/v2/auth?response_type=code&amp;client_id=${ClientID}&amp;redirect_uri=${RedirectUri}&amp;scope=${Scope}&amp;access_type=offline"

    Start-Process $Uri
    $AuthorizationCode = Read-Host 'paste auth code here!'

    $AuthData = @{
        code = $AuthorizationCode;
        client_id = $ClientID;
        client_secret = $ClientSecret;
        redirect_uri = $RedirectUri;
        grant_type = 'authorization_code';
        access_type = 'offline';
    }

    Write-Host 'try to get access token...'
    $TokenResponse = Invoke-RestMethod -Method Post -Uri 'https://www.googleapis.com/oauth2/v4/token' -Body $AuthData
    if (-not $?) {
        throw 'request failed.'
    }

    Write-Host 'done.'

    $script:OAuthCredential = [OAuthCredentialStore]::new(
        ($TokenResponse.access_token | ConvertTo-SecureString -AsPlainText),
        ($TokenResponse.refresh_token | ConvertTo-SecureString -AsPlainText)
    )

    $store = @{
        AccessToken = $OAuthCredential.AccessToken | ConvertFrom-SecureString;
        RefreshToken = $OAuthCredential.RefreshToken | ConvertFrom-SecureString;
    }

    if ($PSCmdlet.ShouldProcess($OAuthStorePath)) {
        New-Item -Path $OAuthStorePath -Force | Out-Null
        $store | ConvertTo-Json -Compress | Set-Content -Path $OAuthStorePath -Force
    }

    $OAuthCredential.AccessToken, $OAuthCredential.RefreshToken
}

function Get-GoogleSheetsAuthToken {
    [CmdletBinding(SupportsShouldProcess)]
    param ()
    Write-Verbose "$OAuthStorePath"
    $content = Get-Content -Path $OAuthStorePath -ErrorAction Ignore
    if ([String]::IsNullOrEmpty($content)) {
        $token, $_ = Get-GoogleSheetsAuthInitToken
        return $token
    }
    try {
        $cred = $content | ConvertFrom-Json
        $script:OAuthCredential = [OAuthCredentialStore]::new(
            ($cred.AccessToken | ConvertTo-SecureString),
            ($cred.RefreshToken | ConvertTo-SecureString)
        )
    }
    catch {
        throw 'Invalid SecureString stored for this module. Remove gs-credential and try again.'
    }
    $RefreshToken = $script:OAuthCredential.RefreshToken | ConvertFrom-SecureString -AsPlainText
    if (-not $RefreshToken) {
        $token, $_ = Get-GoogleSheetsAuthInitToken
        return $token
    }

    $secrets = Get-Content $OAuthClientSecretsPath | ConvertFrom-Json | Select-Object -ExpandProperty installed
    $RefreshData = @{
        refresh_token = $RefreshToken
        client_id = $secrets.client_id
        client_secret = $secrets.client_secret
        grant_type = 'refresh_token'
        access_type = 'offline'
    }

    $Response = Invoke-RestMethod -Method Post -Uri 'https://www.googleapis.com/oauth2/v4/token' -Body $RefreshData
    if (-not $?) {
        throw 'request failed.'
    }

    return $Response.access_token | ConvertTo-SecureString -AsPlainText
}

function Get-GoogleSpreadSheetAsCsv {
    [CmdletBinding()]
    param (
        [Parameter(Mandatory)]
        [String]
        $SpreadSheet,
        [Parameter(Mandatory)]
        [String]
        $SheetId,
        [Parameter(Mandatory)]
        [String]
        $OutFile
    )

    $accessToken, $refreshToken = Get-GoogleSheetsAuthToken
    if (-not $?) {
        return
    }

    $Params = @{
        Uri = "https://docs.google.com/spreadsheets/d/$SpreadSheet/gviz/tq?tqx=out:csv&amp;gid=$($_.SheetId)"
        Method = 'GET'
        Authentication = 'Bearer'
        Token = $accessToken
        OutFile = $ExecutionContext.SessionState.Path.GetUnresolvedProviderPathFromPSPath($OutFile)
    }
    Invoke-WebRequest @Params | Out-Null
}
</code></pre><p>このスクリプトでは認証コードを得るのに手でコピってる。
これを <code>System.Net.HttpListener</code> で自鯖を立てて取る方式にしたかったけど、コピペするのは初回だけだし放置してたらそのままスクリプトの寿命が来てしまった。
自動で認証コードを得る方式は以前ググってそれっぽいの見つけてたはずだが、 URL を失念してしまった。
今なら ChatGPT サンにお願いしたら書いてくれそうな雰囲気するなと思い試したらそれっぽいのが出たが、 OAuth client の Redirect URL を変えるのが手間で検証しなかった。怠けてる。
次にやる機会が来るその日まで、自鯖で認証コード取る方式は寝かせておく(やる日は来るのか)。</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/powershell">powershell</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts/2023-04-09-writing-cmdlet-in-fsharp-pt18">&laquo; 2023-04-09 F#でコマンドレットを書いてる pt.18</a>
        
        
        <a class="right" href="/posts/2023-03-26-writing-cmdlet-in-fsharp-pt17">2023-03-26 F#でコマンドレットを書いてる pt.17 &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2019-2023 krymtkts
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/js/bootstrap.bundle.min.js" integrity="sha512-9GacT4119eY3AcosfWtHMsT5JyZudrexyEVzTBWV3viP/YfB9e2pEy3N7WXL3SV6ASXpTU0vzzSxsbfsuUH4sQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
