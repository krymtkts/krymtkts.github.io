<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>krymtkts: F#でコマンドレットを書いてる pt.14</title>
    <link rel="canonical" href="https://krymtkts.github.io/posts/2023-03-05-writing-cmdlet-in-fsharp-pt14">
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <meta name="description" content="krymtkts&#39;s personal blog">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="krymtkts&#39;s personal blog" />
    <meta property="og:site_name" content="krymtkts" />
    <meta property="og:title" content="krymtkts: F#でコマンドレットを書いてる pt.14" />
    <meta property="og:url" content="https://krymtkts.github.io/posts/2023-03-05-writing-cmdlet-in-fsharp-pt14" />
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/css/bootstrap.min.css" integrity="sha512-XWTTruHZEYJsxV3W/lSXG1n3Q39YIWOstqvmFsdNEEQfHoZ6vm6E9GK2OrF6DSJSpIbRbi+Nn0WDPID9O7xB2Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/fontawesome.min.css" integrity="sha512-R+xPS2VPCAFvLRy+I4PgbwkWjw1z5B5gNDYgJN5LfzV4gGNeRQyVrY7Uk59rX+c8tzz63j8DeZPLqmXvBxj8pA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/base16/solarized-dark.min.css" integrity="sha512-kBHeOXtsKtA97/1O3ebZzWRIwiWEOmdrylPrOo3D2+pGhq1m+1CroSOVErIlsqn1xmYowKfQNVDhsczIzeLpmg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-expand-lg navbar-default">
    <div class="container">
        <div class="navbar-header d-flex w-100 justify-content-between">
            <a class="navbar-brand" href="/">krymtkts</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a  class="nav-link "  href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a  class="nav-link "  href="/archives">Archives</a>
                </li>
                
                <li class="nav-item">
                    <a  class="nav-link "  href="/pages/about">About Me</a>
                </li>
                
                <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" id="dropdown-menu-link" data-bs-toggle="dropdown" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-menu-link">
                        

                        
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a class="dropdown-item" href="/posts/2023-05-20-bump-openssh-chocolatey">Chocolatey で Portable OpenSSH を更新する 2023</a></li>
                        
                        <li><a class="dropdown-item" href="/posts/2023-05-14-rebuild-blog-with-fable-pt3">Fable でブログを再構築する pt.3</a></li>
                        
                        <li><a class="dropdown-item" href="/posts/2023-05-07-rebuild-blog-with-fable-pt2">Fable でブログを再構築する pt.2</a></li>
                        
                        

                        
                        <li><hr class="dropdown-divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a class="dropdown-item" href="/tags/biasamp">biasamp</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/poco">poco</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/windows-terminal">windows-terminal</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/tips">tips</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/evernote">evernote</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/qunit">qunit</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/cryogen">cryogen</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/mouse">mouse</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/nyc">nyc</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/ouraring">ouraring</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/diary">diary</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/github">github</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/clojure">clojure</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/vscode">vscode</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/stepfunctions">stepfunctions</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/aws">aws</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/shieldsio">shieldsio</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/retrospective">retrospective</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/boto3">boto3</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/job">job</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/oh-my-posh">oh-my-posh</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/elm">elm</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/elb">elb</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/openssh">openssh</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/electron">electron</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/powershell">powershell</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/gist">gist</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/planck">planck</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/acm">acm</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/fable">fable</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/php">php</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/go">go</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/mechanicalkeyboard">mechanicalkeyboard</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/pandoc">pandoc</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/fsharp">fsharp</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/cvs2git">cvs2git</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/windows">windows</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/maven">maven</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/font">font</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/git">git</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/docker">docker</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/todo">todo</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/sh">sh</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/cement">cement</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/psake">psake</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/textlin">textlin</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/python">python</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/golang">golang</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/fnm">fnm</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/lambda">lambda</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/tortoisegit">tortoisegit</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/docker-toolbox">docker-toolbox</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/serverless">serverless</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/qmkfirmware">qmkfirmware</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/razer">razer</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/nodejs">nodejs</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/goal">goal</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/powershellgallery">powershellgallery</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/puppeteer">puppeteer</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">2023-03-05</div>
        
    </div>
    <h2>F#でコマンドレットを書いてる pt.14</h2>
</div>
<div>
    
    <p><a href="https://github.com/krymtkts/pocof">krymtkts/pocof</a> の話。</p><p>以下を参考に xUnit と FsUnit を導入した。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/dotnet/core/testing/unit-testing-fsharp-with-dotnet-test">dotnet テストと xUnit を使用した .NET Core での単体テスト F# - .NET | Microsoft Learn</a></li><li><a href="https://fsprojects.github.io/FsUnit/xUnit.html">FsUnit for xUnit</a></li><li><a href="https://fsprojects.github.io/FsUnit/FsUnitTyped.html">What is FsUnitTyped?</a></li><li><a href="https://learn.microsoft.com/ja-jp/dotnet/core/testing/unit-testing-code-coverage?tabs=windows#code-coverage-tooling">単体テストにコードカバレッジを使用する - .NET | Microsoft Learn</a></li></ul><p>repo ルートを作業ディレクトリとする。</p><pre><code class="powershell">cd (mkdir pocof.Test)
dotnet new xunit -lang "F#"
dotnet add reference ../pocof/pocof.fsproj
dotnet sln ../../pocof.sln add .\pocof.Test.fsproj
cd ../../
dotnet build
</code></pre><p>一応ここでちゃんとテストできるか確認をする。<code>Tests.fs</code> のコードを単純なのに書き換える。</p><pre><code class="fsharp">module Tests

open System
open Xunit

[&lt;Fact&gt;]
let ``My test`` () = Assert.True(true)
</code></pre><p>VS Code からでもよし、 CLI でなら repo のルートで以下の通り。</p><pre><code class="powershell">PS&gt; dotnet test
  Determining projects to restore...
  All projects are up-to-date for restore.
  pocof -&gt; C:\Users\takatoshi\dev\github.com\krymtkts\pocof\src\pocof\bin\Debug\net6.0\pocof.dll
C:\Users\takatoshi\dev\github.com\krymtkts\pocof\src\pocof.Test\Tests.fs(7,39): warning FS0988: Main module of program is empty: noth
ing will happen when it is run [C:\Users\takatoshi\dev\github.com\krymtkts\pocof\src\pocof.Test\pocof.Test.fsproj]
  pocof.Test -&gt; C:\Users\takatoshi\dev\github.com\krymtkts\pocof\src\pocof.Test\bin\Debug\net6.0\pocof.Test.dll
Test run for C:\Users\takatoshi\dev\github.com\krymtkts\pocof\src\pocof.Test\bin\Debug\net6.0\pocof.Test.dll (.NETCoreApp,Version=v6.0)
Microsoft (R) Test Execution Command Line Tool Version 17.5.0 (x64)
Copyright (c) Microsoft Corporation.  All rights reserved.

Starting test execution, please wait...
A total of 1 test files matched the specified pattern.

Passed!  - Failed:     0, Passed:     1, Skipped:     0, Total:     1, Duration: &lt; 1 ms - pocof.Test.dll (net6.0)
</code></pre><p>あと <code>dotnet new xunit -lang "F#"</code> で生成された <code>Program.fs</code> は不要なので削除、 <code>pocof.Text.fsproj</code> からも削除する。</p><p>次に FsUnit を追加する。</p><pre><code class="powershell">dotnet add ./src/pocof.Test/pocof.Test.fsproj package FsUnit.xUnit
</code></pre><p>テストをこんな感じで書き換え、 <code>dotnet test</code> が成功したら完了。</p><pre><code class="diff"> module Tests

-open System
 open Xunit
+open FsUnitTyped

-[&lt;Fact&gt;]
-let ``My test`` () = Assert.True(true)
+module ``Pocof Tests`` =
+
+    [&lt;Fact&gt;]
+    let ``Sample test should equals 1`` () = 1 |&gt; shouldEqual 1
+
+[&lt;EntryPoint&gt;]
+let main argv = 0
</code></pre><p><a href="https://github.com/dotnet/fsharp/issues/2669">"Main module of program is empty: nothing will happen when it is run" warning when running xunit tests on .net core. · Issue #2669 · dotnet/fsharp</a> で知ったが、 テストプロジェクトはコンソールアプリなので <code>&lt;EntryPoint&gt;</code> を必ず持たないと警告がでる。 xUnit 追加後シンプルにしたテストコードでは <code>&lt;EntryPoint&gt;</code> がなかったので警告が出てた。</p><p>ちょっとわからないのが VS Code からの実行だとハングしてるようだった。
テストを実行するための DotNet CLI が後ろで実行されるみたいだが、そのプロセスは上手く行ってそうに見える。でも GUI がずっとくるくる止まる。どうも Inonide がエラーしてるっぽい。 xUnit の実行確認のときはいけたので FsUnit 起因か？ちょっと調べる必要ありだが、今回は先送りにする。</p><pre><code class="log">2023-03-04 15:50:47.005 [error] Error:
    at MapTreeModule_find (c:\Users\takatoshi\.vscode\extensions\ionide.ionide-fsharp-7.5.1\webpack:\out\fable_modules\fable-library.4.0.0-theta-018\Map.js:245:15)
    at FSharpMap__get_Item (c:\Users\takatoshi\.vscode\extensions\ionide.ionide-fsharp-7.5.1\webpack:\out\fable_modules\fable-library.4.0.0-theta-018\Map.js:1179:12)
    at f (c:\Users\takatoshi\.vscode\extensions\ionide.ionide-fsharp-7.5.1\webpack:\out\fable_modules\fable-library.4.0.0-theta-018\Map.js:1297:12)
    at Kt (c:\Users\takatoshi\.vscode\extensions\ionide.ionide-fsharp-7.5.1\webpack:\out\fable_modules\fable-library.4.0.0-theta-018\Array.js:70:21)
    at c:\Users\takatoshi\.vscode\extensions\ionide.ionide-fsharp-7.5.1\webpack:\out\Components\TestExplorer.js:138:27
    at processTicksAndRejections (node:internal/process/task_queues:96:5)
    at async Promise.all (index 0)
</code></pre><p>コードカバレッジは xUnit のテンプレなら初めから統合されてるらしくて、すぐ出せる。これはめちゃくちゃ楽。</p><pre><code class="powershell">dotnet test --collect:"XPlat Code Coverage"
</code></pre><p>こんな感じでレポート出力できる。出力しておいたら VS Code の <a href="https://marketplace.visualstudio.com/items?itemName=ryanluker.vscode-coverage-gutters">Coverage Gutters</a> で取り込めるしこりゃいいな。</p><pre><code class="powershell">reportgenerator -reports:".\src\pocof.Test\TestResults\*\coverage.cobertura.xml" -targetdir:"coverage" -reporttypes:Html
</code></pre><hr /><p>昔は Visual Studio からしか Solution とか作るしかなかったようなキヲクをがある(無能だっただけやも知れんが)。
いまの DotNet CLI ある時代めちゃくちゃ便利でびっくりした。</p><p>あと FsUnit 非常によい。
入力キーから処理を導くところのリファクタするのに役立っている。
サクサク書けるし、バグってた状態で放置してるとこが見つかったり(<a href="https://github.com/krymtkts/pocof/pull/33">#33</a>)いまのところ良いことしか無い。</p><p>いい感じにテスト揃ってきたら、 GitHub Actions で FsUnit と Pester 実行するようにしよう。</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/powershell">powershell</a>
    
    <a href="/tags/fsharp">fsharp</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts/2023-03-12-writing-cmdlet-in-fsharp-pt15">&laquo; 2023-03-12 F#でコマンドレットを書いてる pt.15</a>
        
        
        <a class="right" href="/posts/2023-02-26-writing-cmdlet-in-fsharp-pt13">2023-02-26 F#でコマンドレットを書いてる pt.13 &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2019-2023 krymtkts
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/js/bootstrap.bundle.min.js" integrity="sha512-9GacT4119eY3AcosfWtHMsT5JyZudrexyEVzTBWV3viP/YfB9e2pEy3N7WXL3SV6ASXpTU0vzzSxsbfsuUH4sQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
