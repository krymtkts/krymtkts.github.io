<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>krymtkts: 古のはてなダイアリー XML を Markdwon に変換する(いい感じに)</title>
    <link rel="canonical" href="https://krymtkts.github.io/posts/2022-04-16-convert-hatena-xml-to-md">
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <meta name="description" content="krymtkts&#39;s personal blog">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="krymtkts&#39;s personal blog" />
    <meta property="og:site_name" content="krymtkts" />
    <meta property="og:title" content="krymtkts: 古のはてなダイアリー XML を Markdwon に変換する(いい感じに)" />
    <meta property="og:url" content="https://krymtkts.github.io/posts/2022-04-16-convert-hatena-xml-to-md" />
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/solarized-dark.min.css" integrity="sha256-90Y+fvi28WF+3jKH4tHEkoQ9WLeFKJjpvCPNOtU9ZvU=" crossorigin="anonymous" />
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">krymtkts</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives">Archives</a></li>
                
                <li
                >
                <a href="/pages/about">About Me</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        

                        
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a href="/posts/2022-07-09-tips-for-sending-http-requests-pwsh">PowerShell で大量の HTTP リクエストを送る場合の Tips</a></li>
                        
                        <li><a href="/posts/2022-07-03-aws-cdk-with-fsharp">F# で AWS CDK して躓いてる</a></li>
                        
                        <li><a href="/posts/2022-06-26-writing-cmdlet-in-fsharp-pt3">F#でコマンドレットを書いてる pt.3</a></li>
                        
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a href="/tags/biasamp">biasamp</a></li>
                        
                        <li><a href="/tags/poco">poco</a></li>
                        
                        <li><a href="/tags/tips">tips</a></li>
                        
                        <li><a href="/tags/evernote">evernote</a></li>
                        
                        <li><a href="/tags/qunit">qunit</a></li>
                        
                        <li><a href="/tags/cryogen">cryogen</a></li>
                        
                        <li><a href="/tags/mouse">mouse</a></li>
                        
                        <li><a href="/tags/nyc">nyc</a></li>
                        
                        <li><a href="/tags/diary">diary</a></li>
                        
                        <li><a href="/tags/github">github</a></li>
                        
                        <li><a href="/tags/clojure">clojure</a></li>
                        
                        <li><a href="/tags/vscode">vscode</a></li>
                        
                        <li><a href="/tags/stepfunctions">stepfunctions</a></li>
                        
                        <li><a href="/tags/aws">aws</a></li>
                        
                        <li><a href="/tags/shieldsio">shieldsio</a></li>
                        
                        <li><a href="/tags/retrospective">retrospective</a></li>
                        
                        <li><a href="/tags/boto3">boto3</a></li>
                        
                        <li><a href="/tags/job">job</a></li>
                        
                        <li><a href="/tags/oh-my-posh">oh-my-posh</a></li>
                        
                        <li><a href="/tags/elm">elm</a></li>
                        
                        <li><a href="/tags/elb">elb</a></li>
                        
                        <li><a href="/tags/openssh">openssh</a></li>
                        
                        <li><a href="/tags/powershell">powershell</a></li>
                        
                        <li><a href="/tags/gist">gist</a></li>
                        
                        <li><a href="/tags/planck">planck</a></li>
                        
                        <li><a href="/tags/acm">acm</a></li>
                        
                        <li><a href="/tags/php">php</a></li>
                        
                        <li><a href="/tags/go">go</a></li>
                        
                        <li><a href="/tags/mechanicalkeyboard">mechanicalkeyboard</a></li>
                        
                        <li><a href="/tags/pandoc">pandoc</a></li>
                        
                        <li><a href="/tags/fsharp">fsharp</a></li>
                        
                        <li><a href="/tags/windows">windows</a></li>
                        
                        <li><a href="/tags/maven">maven</a></li>
                        
                        <li><a href="/tags/font">font</a></li>
                        
                        <li><a href="/tags/git">git</a></li>
                        
                        <li><a href="/tags/docker">docker</a></li>
                        
                        <li><a href="/tags/todo">todo</a></li>
                        
                        <li><a href="/tags/sh">sh</a></li>
                        
                        <li><a href="/tags/cement">cement</a></li>
                        
                        <li><a href="/tags/psake">psake</a></li>
                        
                        <li><a href="/tags/textlin">textlin</a></li>
                        
                        <li><a href="/tags/python">python</a></li>
                        
                        <li><a href="/tags/golang">golang</a></li>
                        
                        <li><a href="/tags/fnm">fnm</a></li>
                        
                        <li><a href="/tags/lambda">lambda</a></li>
                        
                        <li><a href="/tags/tortoisegit">tortoisegit</a></li>
                        
                        <li><a href="/tags/docker-toolbox">docker-toolbox</a></li>
                        
                        <li><a href="/tags/serverless">serverless</a></li>
                        
                        <li><a href="/tags/qmkfirmware">qmkfirmware</a></li>
                        
                        <li><a href="/tags/nodejs">nodejs</a></li>
                        
                        <li><a href="/tags/goal">goal</a></li>
                        
                        <li><a href="/tags/powershellgallery">powershellgallery</a></li>
                        
                        <li><a href="/tags/puppeteer">puppeteer</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">2022-04-16</div>
        
    </div>
    <h2>古のはてなダイアリー XML を Markdwon に変換する(いい感じに)</h2>
</div>
<div>
    
    <p>先日 Google ドライブの中に眠っていた XML を発掘した。古のはてなダイアリーからエクスポートされたやつだこれ。</p><p>昔、プレーンテキストで日記をつけ始める前に、誰に見せるでもないブログを書いていた。何度かブログサービスに書いては止めるを繰り返していた。
そのうち最も最近までやってたのがはてなダイアリーで、そのバックアップがこれっぽい。
178 記事、2009 ~ 2011 の 3 年間もあるのに、すっかり忘れていた。</p><p>これはぜひ今の日記に統合したい。ということではてなダイアリーの XML を Markdown に変換して取り込むことにした。</p><h3 id="変換する">変換する</h3><p>今回は Pandoc を使わず純粋に PowerShell だけで処理する。
Pandoc で<a href="https://help.hatenablog.com/entry/text-hatena-list">はてな記法</a>から Markdown に変換できるが、ごく一部の記事は既に日記があって追記しないといけないこともあり、PowerShell だけでやる方が融通が利く。</p><p>XML なら PowerShell の主戦場なので、何をするにも楽だ。
使っているはてな記法もおおよそパターンマッチで置換できる(鬼の連続置換)。</p><p>引用だけ正規表現での変換がわからんけど、一桁件数しかなかったので、手で書き換える。</p><p>以下変換スクリプト。 <code>hatena2md.ps1</code></p><pre><code class="powershell">[CmdletBinding()]
param (
    [Parameter(
        Mandatory,
        HelpMessage = "XML Path of hatena diary.")]
    [ValidateScript({
            if (-Not ($_ | Test-Path) -or ($_ -notmatch "\.xml")) {
                throw "The file specified in the XmlPath argument must be XML."
            }
            return $True
        })]
    [System.IO.FileInfo]
    $XmlPath,
    [Parameter(
        Mandatory,
        HelpMessage = "Output Path of Markdown diaries.")]
    [ValidateScript({
            if (-Not (Test-Path $_ ) -or -not (Test-Path $_ -PathType Container)) {
                throw "The BlogPath argument must be a folder."
            }
            return $True
        })]
    [System.IO.FileInfo]
    $BlogPath
)

$xml = [XML](Get-Content $XmlPath)
Write-Host "Convert $($xml.diary.day.Length) hatena XML to Markdown."

$xml.diary.day | ForEach-Object {
    $date = Get-Date $_.date -ErrorAction SilentlyContinue
    if (-not $?) {
        Write-Error "Cannot convert diary of $($_.date)"
        return
    }
    $diaryPath = "$BlogPath/$($date.Year)/$($date.ToString('yyyy-MM'))/$($date.toString('dd')).md"
    Get-ChildItem $diaryPath -ErrorAction SilentlyContinue | Out-Null
    if ($?) {
        Write-Host "Add Content to exists diary of $($_.date)"
        $InvokeContent = 'Add-Content'
        $content = @"

## はてなの日記

"@
    }
    else {
        Write-Host "Create new diary of $($_.date)"
        $InvokeContent = 'Set-Content'
        mkdir -Force (Split-Path $diaryPath -Parent) | Out-Null
        $content = @"
# $($date.ToString('yyyy-MM/dd (ddd)'))

## はてなの日記

"@
    }
    $content += (
        $_.body -split "`n" | ForEach-Object {
            $_ `
                -replace '^\*\d+\*(.+)$', "### `$1`n" `
                -replace '^=+$', "`n---`n" `
                -replace '^--(.+)', '    - $1' `
                -replace '^-(.+)', '- $1' `
                -replace '^\+\+(.+)', '    1. $1' `
                -replace '^\+(.+)', '1. $1' `
                -replace '\&gt;\|(\w+)\|', "`n```````$1" `
                -replace '(\&gt;\|\||\&gt;\|)', "`n``````" `
                -replace '(\|\|\&lt;|\|\&lt;)', "```````n" `
                -replace '\[(.+?)\:title=(.+?)]', '[$2]($1)'
        }) -join "`n"
    $content | &amp; $InvokeContent -Path $diaryPath -Encoding utf8 -NoNewline | Out-Null
}
</code></pre><p>はてなダイアリーの XML から、自分の日記の構造に変換している。
はてなダイアリーの記事にはわかりやすく「はてなの日記」というセクションを設ける。</p><p>基本ファイルを作成するが、既存のファイルが存在する場合は、追記する。
先述の通りセクションがあるので追記しても自然だ。</p><p>ディレクトリ構造は<a href="/posts/2022-04-02-convert-textile-to-md">前回の Textile → Markdown 変換</a> で記した通り ↓ 。 1 つの XML からこの形にファイルを出力する。</p><pre><code class="plaintext">+---2013
|   +---2013-01
|   |       17.textile
|   ︙      ︙
︙
\---2022
   +---2022-01
   ︙
   \---2022-03
            01.md
            ︙
            31.md
</code></pre><p>実行する。</p><pre><code class="powershell">. .\hatena2md.ps1 -XmlPath $XmlPath -BlogPath $BlogPath
</code></pre><h3 id="変換後の処理">変換後の処理</h3><p>変換後のファイルから<code>&gt;&gt;</code> で検索して該当するものを一覧し、書き換える。</p><pre><code class="powershell">ls -File -Recurse | ? {cat $_ | % {$_ -split "`n"} | ? {$_ -match '^&gt;&gt;'}} | select -Property FullName
</code></pre><p>ココに来て順序付きリストの数字をやっぱりインクリメントしたい(前のステップでは<code>1.</code>固定でいいかと思ってた)...ということで一部書き直した。</p><p>最後に全体を <a href="https://prettier.io/">Prettier</a> で清書する。</p><pre><code class="powershell">prettier --write .
</code></pre><p>最終チェックをして完了。</p><h3 id="まとめ">まとめ</h3><p>Textile からの変換よりも、量が 1/10 程度と少なかったこともあり、簡単にできた。</p><p>コンテンツそれ自体は中々に青臭く、読んでると「わー！！！」と声を上げたくなるところもある。
ただ人生の転機が集中した期間だったこともあって、興味深い内容だった。貴重なログなので、これまた自己分析に使いたい。</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/powershell">powershell</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts/2022-04-23-aws-rehabilitation">&laquo; 2022-04-23 AWS リハビリのハマり集</a>
        
        
        <a class="right" href="/posts/2022-04-09-jobchange-2022">2022-04-09 転職した 2022 &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2019-2022 krymtkts
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
