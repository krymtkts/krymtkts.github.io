<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>krymtkts: East Asian な全角文字をキーに使った場合のアラインメントについて考える</title>
    <link rel="canonical" href="https://krymtkts.github.io/posts/2022-05-14-think-about-alignment-of-full-width-chars">
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <meta name="description" content="krymtkts&#39;s personal blog">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="krymtkts&#39;s personal blog" />
    <meta property="og:site_name" content="krymtkts" />
    <meta property="og:title" content="krymtkts: East Asian な全角文字をキーに使った場合のアラインメントについて考える" />
    <meta property="og:url" content="https://krymtkts.github.io/posts/2022-05-14-think-about-alignment-of-full-width-chars" />
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/solarized-dark.min.css" integrity="sha256-90Y+fvi28WF+3jKH4tHEkoQ9WLeFKJjpvCPNOtU9ZvU=" crossorigin="anonymous" />
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">krymtkts</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives">Archives</a></li>
                
                <li
                >
                <a href="/pages/about">About Me</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        

                        
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a href="/posts/2022-06-12-writing-cmdlet-in-fsharp-pt2">F#でコマンドレットを書いてる pt.2</a></li>
                        
                        <li><a href="/posts/2022-06-05-whitespace-comparison-in-pwsh">PoweShell で半角スペース(U+0020) -eq 全角スペース(U+3000) が True となる</a></li>
                        
                        <li><a href="/posts/2022-05-28-writing-cmdlet-in-fsharp">F#でコマンドレットを書いてる</a></li>
                        
                        

                        
                        <li class="divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a href="/tags/biasamp">biasamp</a></li>
                        
                        <li><a href="/tags/poco">poco</a></li>
                        
                        <li><a href="/tags/tips">tips</a></li>
                        
                        <li><a href="/tags/evernote">evernote</a></li>
                        
                        <li><a href="/tags/qunit">qunit</a></li>
                        
                        <li><a href="/tags/cryogen">cryogen</a></li>
                        
                        <li><a href="/tags/mouse">mouse</a></li>
                        
                        <li><a href="/tags/nyc">nyc</a></li>
                        
                        <li><a href="/tags/diary">diary</a></li>
                        
                        <li><a href="/tags/github">github</a></li>
                        
                        <li><a href="/tags/clojure">clojure</a></li>
                        
                        <li><a href="/tags/vscode">vscode</a></li>
                        
                        <li><a href="/tags/stepfunctions">stepfunctions</a></li>
                        
                        <li><a href="/tags/aws">aws</a></li>
                        
                        <li><a href="/tags/shieldsio">shieldsio</a></li>
                        
                        <li><a href="/tags/retrospective">retrospective</a></li>
                        
                        <li><a href="/tags/boto3">boto3</a></li>
                        
                        <li><a href="/tags/job">job</a></li>
                        
                        <li><a href="/tags/oh-my-posh">oh-my-posh</a></li>
                        
                        <li><a href="/tags/elm">elm</a></li>
                        
                        <li><a href="/tags/elb">elb</a></li>
                        
                        <li><a href="/tags/openssh">openssh</a></li>
                        
                        <li><a href="/tags/powershell">powershell</a></li>
                        
                        <li><a href="/tags/gist">gist</a></li>
                        
                        <li><a href="/tags/planck">planck</a></li>
                        
                        <li><a href="/tags/acm">acm</a></li>
                        
                        <li><a href="/tags/php">php</a></li>
                        
                        <li><a href="/tags/go">go</a></li>
                        
                        <li><a href="/tags/mechanicalkeyboard">mechanicalkeyboard</a></li>
                        
                        <li><a href="/tags/pandoc">pandoc</a></li>
                        
                        <li><a href="/tags/fsharp">fsharp</a></li>
                        
                        <li><a href="/tags/windows">windows</a></li>
                        
                        <li><a href="/tags/maven">maven</a></li>
                        
                        <li><a href="/tags/font">font</a></li>
                        
                        <li><a href="/tags/git">git</a></li>
                        
                        <li><a href="/tags/docker">docker</a></li>
                        
                        <li><a href="/tags/todo">todo</a></li>
                        
                        <li><a href="/tags/sh">sh</a></li>
                        
                        <li><a href="/tags/cement">cement</a></li>
                        
                        <li><a href="/tags/psake">psake</a></li>
                        
                        <li><a href="/tags/textlin">textlin</a></li>
                        
                        <li><a href="/tags/python">python</a></li>
                        
                        <li><a href="/tags/golang">golang</a></li>
                        
                        <li><a href="/tags/fnm">fnm</a></li>
                        
                        <li><a href="/tags/lambda">lambda</a></li>
                        
                        <li><a href="/tags/tortoisegit">tortoisegit</a></li>
                        
                        <li><a href="/tags/docker-toolbox">docker-toolbox</a></li>
                        
                        <li><a href="/tags/serverless">serverless</a></li>
                        
                        <li><a href="/tags/qmkfirmware">qmkfirmware</a></li>
                        
                        <li><a href="/tags/nodejs">nodejs</a></li>
                        
                        <li><a href="/tags/goal">goal</a></li>
                        
                        <li><a href="/tags/powershellgallery">powershellgallery</a></li>
                        
                        <li><a href="/tags/puppeteer">puppeteer</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">2022-05-14</div>
        
    </div>
    <h2>East Asian な全角文字をキーに使った場合のアラインメントについて考える</h2>
</div>
<div>
    
    <p>掲題のとおりである。
ここでいうアラインメントはメモリの話じゃなくて、字面上の整列のことを指す。</p><p>自分の中でもどうあるべきかまだ結論が出せてないので、考えをまとめるために書く。</p><h3 id="問題">問題</h3><p>いま、 <a href="https://github.com/PowerShell/PSScriptAnalyzer">PSScriptAnalyzer</a> で全角文字をキーに持つ hashtable を整形したとき期待どおりにならなのだけど、どう解決するのがいいのだろう？と悩んでる。</p><p>一応弁解しておくと、わたしの気持ちとしては「そんなところに全角文字使うとか危なげなことやめようや」だ。</p><p>ところが、今やってる仕事でスプレッドシートのデータをシステムに取り込むにあたり、それらをいくつかの CSV に分解・再構築する必要があって、その中でこのテーマに直面した。 PSCustomObject を CSV に変換する形でスクリプトを作ってるので、全角文字が識別子になるのだ。</p><p>普通に自分が書く範囲だとこんなの書かないので、最近まで気づかなかった。</p><p>VS Code で PowerShell を書くと、自動整形には <a href="https://github.com/PowerShell/PSScriptAnalyzer">PSScriptAnalyzer</a> の <code>Invoke-Formatter</code> が使われる。この戻り値が整形後のコードになるのだけど、ここで今回のテーマに直面する。</p><p>問題は以下のコードで再現できる。</p><pre><code class="powershell">$settings = @{
    IncludeRules = @(
        'PSAlignAssignmentStatement'
    )

    Rules = @{
        PSAlignAssignmentStatement = @{
            Enable = $true
            # PSAlignAssignmentStatement.CheckHashtable が真だと、
            # hashtable の要素の並びを整形してくれる。
            CheckHashtable = $true
        }
    }
}

$script = @'
$test = @{
    A = 0
    ABC = 0
    ABCDE = 0
    Ａ = 0
    ＡＢＣ = 0
    ＡＢＣＤＥ = 0
}
'@
Invoke-Formatter -ScriptDefinition $script -Settings $settings
</code></pre><p>出力はこうなる。これは期待のとおりではない。</p><pre><code class="powershell">$test = @{
    A     = 0
    ABC   = 0
    ABCDE = 0
    Ａ     = 0
    ＡＢＣ   = 0
    ＡＢＣＤＥ = 0
}
</code></pre><p>わたしはこうなってほしいと考える。</p><pre><code class="powershell">$test = @{
    A          = 0
    ABC        = 0
    ABCDE      = 0
    Ａ         = 0
    ＡＢＣ     = 0
    ＡＢＣＤＥ = 0
}
</code></pre><p>PSScriptAnalyzer のコードを調べて、 PSScriptAnalyzer 的には PowerShell のパーサが返した列番号(<code>EndColumnNumber</code>)の通りに整形してるのがわかった。
<a href="https://github.com/PowerShell/PSScriptAnalyzer/blob/58c44234d44dfd0db35bb532906963e08fde8621/Rules/AlignAssignmentStatement.cs#L194">PSScriptAnalyzer/AlignAssignmentStatement.cs GetHashtableCorrections の L194</a></p><p>次に PowerShell のパーサを直接調べる。</p><pre><code class="powershell">$script = @'
$test = @{
    A = 0
    ABC = 0
    ABCDE = 0
    Ａ = 0
    ＡＢＣ = 0
    ＡＢＣＤＥ = 0
}
'@

function getColumnNumberString {
    param (
        $Extent
    )
    "start $($Extent.StartColumnNumber.ToString().PadLeft(2)) end $($Extent.EndColumnNumber.ToString().PadLeft(2))"
}

$ast = [System.Management.Automation.Language.Parser]::ParseInput($script, [ref]$null, [ref]$null)
$hashAst = $ast.FindAll({ $args[0] -is [System.Management.Automation.Language.HashtableAst] }, $true)
$hashAst.KeyValuePairs | ForEach-Object {
    # Item1 がキーの情報、 Item2 は '=' の情報
    $e1, $e2 = $_.Item1.Extent, $_.Item2.Extent
    "key $(getColumnNumberString($e1)) | '=' $(getColumnNumberString($e2))"
}
</code></pre><p>出力はこうなって、全角文字の表示幅は考慮されてないのがわかる。</p><pre><code class="txt">key start  5 end  6 | '=' start  9 end 10
key start  5 end  8 | '=' start 11 end 12
key start  5 end 10 | '=' start 13 end 14
key start  5 end  6 | '=' start  9 end 10
key start  5 end  8 | '=' start 11 end 12
key start  5 end 10 | '=' start 13 end 14
</code></pre><p>じゃあこれは PowerShell のバグなのか？とまで考えを至らせると、いやパーサは表示する文字の幅を意識する必要あるか？と思えるので、これは誰が解決する問題なんや...と思っているのが、今の状況。</p><h3 id="他の言語を調べる">他の言語を調べる</h3><p>他の事例を調べて、全角文字を含むキーや識別子をアラインメントするとどうなるか比べてみる。</p><p>とはいえ、他の言語でアラインメントするようなフォーマットかける言語何があったっけ？
少なくとも Python は違ったし、思いついたのは Go だけ。
Go 以外にも思いついたら追加したい。</p><h4 id="go">Go</h4><p>こんな中身の <code>test.go</code> があるとする。</p><pre><code class="go">package main

type person struct {
	A int
	ABC int
	ABCDE int
	Ａ int
	ＡＢＣ int
	ＡＢＣＤＥ int
}
</code></pre><p>これに <code>gofmt ./test.go</code> すると次の通り。</p><pre><code class="go">package main

type person struct {
        A     int
        ABC   int
        ABCDE int
        Ａ     int
        ＡＢＣ   int
        ＡＢＣＤＥ int
}
</code></pre><p>やっぱり！ PowerShell の結果と同じ。</p><h3 id="現時点の理解">現時点の理解</h3><p>現実的には、パーサやフォーマッタがフォントの文字幅を考慮しないし、アラインメントしないのが妥当な落とし所なのかな。
気持ちとしては、全角文字を含んだとしても綺麗にアラインメントしてほしいが、それもエッジケースなのでそんなに困ることがない。</p><p>とはいえ Unicode 文字の演算子とかポツポツあるし、幅の規定が厳格であればフォーマッタあたりで解消したいテーマではある気がする。</p><p>なんか締まらない締めになった。</p><p>とりあえず自分用の覚書としては、 PSScriptAnalyzer は <code>PSAlignAssignmentStatement.CheckHashtable=$false</code> で利用すればこの問題に悩まされることもないので、オススメする。</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/powershell">powershell</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts/2022-05-22-customize-my-worn-out-705">&laquo; 2022-05-22 使い古しの Logicool M 705 をカスタマイズする</a>
        
        
        <a class="right" href="/posts/2022-05-07-start-to-write-cmdlet-by-fsharp">2022-05-07 F#で PowerShell コマンドレットを書き始めた &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2019-2022 krymtkts
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
