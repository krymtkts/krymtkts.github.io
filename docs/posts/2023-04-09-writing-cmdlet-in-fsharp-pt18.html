<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>krymtkts: F#でコマンドレットを書いてる pt.18</title>
    <link rel="canonical" href="https://krymtkts.github.io/posts/2023-04-09-writing-cmdlet-in-fsharp-pt18">
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
    <meta name="description" content="krymtkts&#39;s personal blog">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="krymtkts&#39;s personal blog" />
    <meta property="og:site_name" content="krymtkts" />
    <meta property="og:title" content="krymtkts: F#でコマンドレットを書いてる pt.18" />
    <meta property="og:url" content="https://krymtkts.github.io/posts/2023-04-09-writing-cmdlet-in-fsharp-pt18" />
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.0/css/bootstrap.min.css" integrity="sha512-XWTTruHZEYJsxV3W/lSXG1n3Q39YIWOstqvmFsdNEEQfHoZ6vm6E9GK2OrF6DSJSpIbRbi+Nn0WDPID9O7xB2Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/fontawesome.min.css" integrity="sha512-R+xPS2VPCAFvLRy+I4PgbwkWjw1z5B5gNDYgJN5LfzV4gGNeRQyVrY7Uk59rX+c8tzz63j8DeZPLqmXvBxj8pA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/base16/solarized-dark.min.css" integrity="sha512-kBHeOXtsKtA97/1O3ebZzWRIwiWEOmdrylPrOo3D2+pGhq1m+1CroSOVErIlsqn1xmYowKfQNVDhsczIzeLpmg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
</head>
<body>


<nav class="navbar navbar-expand-lg navbar-default">
    <div class="container">
        <div class="navbar-header d-flex w-100 justify-content-between">
            <a class="navbar-brand" href="/">krymtkts</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a  class="nav-link "  href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a  class="nav-link "  href="/archives">Archives</a>
                </li>
                
                <li class="nav-item">
                    <a  class="nav-link "  href="/pages/about">About Me</a>
                </li>
                
                <li class="nav-item"><a class="nav-link" href="/feed.xml">RSS</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" id="dropdown-menu-link" data-bs-toggle="dropdown" aria-expanded="false">
                        More <span class="caret"></span></a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-menu-link">
                        

                        
                        <li class="dropdown-header">Recent Posts</li>
                        
                        <li><a class="dropdown-item" href="/posts/2023-07-09-migrate-dev-environment">開発環境をプチ移行する</a></li>
                        
                        <li><a class="dropdown-item" href="/posts/2023-07-02-rebuild-blog-with-fable-pt9">Fable でブログを再構築する pt.9</a></li>
                        
                        <li><a class="dropdown-item" href="/posts/2023-06-25-rebuild-blog-with-fable-pt8">Fable でブログを再構築する pt.8</a></li>
                        
                        

                        
                        <li><hr class="dropdown-divider"></li>
                        <li class="dropdown-header">Tags</li>
                        
                        <li><a class="dropdown-item" href="/tags/biasamp">biasamp</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/poco">poco</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/windows-terminal">windows-terminal</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/tips">tips</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/evernote">evernote</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/qunit">qunit</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/cryogen">cryogen</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/mouse">mouse</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/nyc">nyc</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/ouraring">ouraring</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/diary">diary</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/github">github</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/clojure">clojure</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/vscode">vscode</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/stepfunctions">stepfunctions</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/aws">aws</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/shieldsio">shieldsio</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/retrospective">retrospective</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/boto3">boto3</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/job">job</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/oh-my-posh">oh-my-posh</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/elm">elm</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/elb">elb</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/openssh">openssh</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/electron">electron</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/powershell">powershell</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/gist">gist</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/planck">planck</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/acm">acm</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/fable">fable</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/php">php</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/go">go</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/mechanicalkeyboard">mechanicalkeyboard</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/pandoc">pandoc</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/fsharp">fsharp</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/cvs2git">cvs2git</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/windows">windows</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/maven">maven</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/font">font</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/git">git</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/docker">docker</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/todo">todo</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/sh">sh</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/cement">cement</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/psake">psake</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/textlin">textlin</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/python">python</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/golang">golang</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/fnm">fnm</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/lambda">lambda</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/tortoisegit">tortoisegit</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/docker-toolbox">docker-toolbox</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/serverless">serverless</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/qmkfirmware">qmkfirmware</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/razer">razer</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/nodejs">nodejs</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/goal">goal</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/powershellgallery">powershellgallery</a></li>
                        
                        <li><a class="dropdown-item" href="/tags/puppeteer">puppeteer</a></li>
                        
                        
                    </ul>
                </li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">2023-04-09</div>
        
    </div>
    <h2>F#でコマンドレットを書いてる pt.18</h2>
</div>
<div>
    
    <p><a href="https://github.com/krymtkts/pocof">krymtkts/pocof</a> の話。</p><p><code>PocofQuery.run</code> のテストをそれなりに足した。
多少テストが増えてきたので CI が欲しくなってきた。ここで以前立てた Issue <a href="https://github.com/krymtkts/pocof/issues/34">#34</a> を回収しておくとことにした。</p><p>Issue にも書いてたけど、基本 GitHub Docs に書いてたやつをなぞるだけ。</p><ul><li><a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net">Building and testing .NET - GitHub Docs</a></li><li><a href="https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-powershell">Building and testing PowerShell - GitHub Docs</a></li></ul><p>runner image は今の開発環境に合わせて <code>windows-latest</code> にしておく。 pocof 自体は今後他の OS でも動くことを保証してみたいけど、最初なのでシンプルにいく。
この記事を書いた時点の <code>windows-latest</code> に含まれるツール類は以下を参照した。</p><p><a href="https://github.com/actions/runner-images/blob/main/images/win/Windows2022-Readme.md">runner-images/Windows2022-Readme.md at main · actions/runner-images · GitHub</a></p><p><code>dotnet</code> のセットアップは必須のよう。 pocof はまだ 6 なのでそれを使う。</p><p>PowerShell はデフォで 7.2.10 が入ってるらしい。いろんなバージョンで動くことをチェックするのであれば PowerShell の version で <code>matrix</code> 組むのが妥当だが、これも最初なので簡単に。</p><p>pocof のテストに必要な PowerShell モジュール Pester, PSScriptAnalyzer あたりも入ってるが、肝心の <a href="https://github.com/psake/psake">psake</a> が入ってない。ならば workflow で全部ひっくるめで force install するようにしておく。
このへんも <a href="https://github.com/RamblingCookieMonster/PSDepend">PSDepend</a> を使うようにしておけば YAML にかき分ける必要もないし良さげか。</p><p>ここまでやれば <code>psakefile.ps1</code> に書いた全テストタスクを実行すれば完了する。キャッシュあった方が速いだろうけど、そもそもそんなに時間かからんので対応しないでおく。</p><p>あと一番重要な GitHub Actions の YAML のファイル名と名前の部分、結構いろんな repo みても付け方がバラバラでイケてるパクリ元がない。
ここは GitHub の Pull Request や Actions の画面で見られることを考えてない名称は避けたかった。
最終的に、 <a href="https://github.com/fsprojects/FSharp.Formatting/tree/3fdd5b9a186e35798d87ceee4bee692374304bed/.github/workflows">FSharp.Formatting</a> の命名規則が気に入ったのでそれを模した。
ファイル名は <code>pull-requests.yml</code> を短縮して <code>pr.yml</code> で、名前は <code>Build and Test on Pull Request</code> だ。これなら GitHub の画面で見ても自然だ。</p><p>出来上がった素朴な YAML はこちら。 <a href="https://github.com/krymtkts/pocof/blob/1dda928ff1ae56938a26ae70568a9a05807f0852/.github/workflows/pr.yml">pocof/pr.yml</a></p><pre><code class="yaml">name: Build and Test on Pull Request

on:
  pull_request:
    branches: ["main"]

jobs:
  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x
      - name: Install modules from PSGallery
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module Psake,Pester,PSScriptAnalyzer -Scope CurrentUser -Force
      - name: Execute All Tests
        shell: pwsh
        run: Invoke-Psake -taskList TestAll
</code></pre><p>GitHub Actions の難点としてテストしにくい点があるが、<a href="https://github.com/nektos/act">nektos/act</a> を使えば <code>ubuntu-*</code> の runner に限ればテストできる。
仕事では act を使ってるが自機には積んでなかったんで、この際に Chocolaty で入れた。</p><pre><code class="dos">choco install act-cli
</code></pre><p>ではテストとばかりに <code>windows-latest</code> を <code>ubuntu-latest</code> に変えて実行する。</p><pre><code class="powershell">PS&gt; act pull_request --verbose --platform windows-latest=catthehacker/ubuntu:act-latest
# ...省略
| OCI runtime exec failed: exec failed: unable to start container process: exec: "pwsh": executable file not found in $PATH: unknown
# ...省略
Error: Job 'test' failed
</code></pre><p>なん...だと...
<code>pwsh</code> コマンドが無いと言われた... <code>act</code> のセットアップ時に MEDIUM 選んだらどうも入ってないっぽい。
流石は minority の PowerShell 、参ったね。</p><p>しかし <code>act</code> が使うイメージを見てたら <code>pwsh</code> というキーワード付きの image があるじゃないの。 <a href="https://github.com/catthehacker/docker_images#images-available">catthehacker/docker_images: Docker images</a></p><blockquote><p>/linux/ubuntu/pwsh - ghcr.io/catthehacker/ubuntu:act-* but with pwsh tools and modules installed</p></blockquote><p>こりゃきたな。試す。</p><pre><code class="powershell">PS&gt; act pull_request --verbose --platform windows-latest=ghcr.io/catthehacker/ubuntu:pwsh-latest
# ...省略
[Build and Test on Pull Request/test] 🏁  Job succeeded
</code></pre><p>おーいけた。 6 分超かかったけど。
これでなんとか PowerShell の場合でもローカルテストできそう。
Docker Hub に同じイメージ <a href="https://hub.docker.com/layers/catthehacker/ubuntu/pwsh-latest/images/sha256-3b4b83b4458dd875509bc74b9f1d4ecaa57101c65ec529cb463fed2d859228e4?context=explore">catthehacker/ubuntu:pwsh-latest</a> あったので、これを使っていこう。</p><pre><code class="powershell">act pull_request --verbose --platform windows-latest=catthehacker/ubuntu:pwsh-latest
</code></pre><p>...でもいちいちこのクソながオプション書きたく無いなあ...設定ファイルとかはなさそう。関数にするか psake のタスクにするしかないか。なんか大げさな気がするけど。</p><p>そんなこんなで <a href="https://github.com/krymtkts/pocof/pull/45">#45</a> を作れた。
matrix はまだ設定してないけど、少なくともテスト類は ubuntu でも動くことわかったし、追々対応していく。</p><hr /><p>おまけ。</p><p>DockerDesktop でログインしてると、 <code>act</code> 実行中にある DockerHub から <code>catthehacker/ubuntu:act-latest</code> を pull するのができなかった。ログアウトしてるといける。↓ このへんの関係ぽいが深く追ってない。</p><p><a href="https://github.com/nektos/act/discussions/1165">m1: act fails to pull with unauthorized: incorrect username or password · nektos/act · Discussion #1165</a></p><p>あとなんか知らんが <code>act</code> 実行後に <code>[45;3R</code> って謎キーワードが terminal の input に出てくる、必ず。 ansi escape sequences ぽいけどよくわからん。</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/github">github</a>
    
    <a href="/tags/powershell">powershell</a>
    
    <a href="/tags/fsharp">fsharp</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts/2023-04-16-writing-cmdlet-in-fsharp-pt19">&laquo; 2023-04-16 F#でコマンドレットを書いてる pt.19</a>
        
        
        <a class="right" href="/posts/2023-04-02-oauth-with-pwsh-to-download-gss-as-csv">2023-04-02 PowerShell で OAuth して Google Sheet を CSV で DL する &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2019-2023 krymtkts
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/js/bootstrap.bundle.min.js" integrity="sha512-9GacT4119eY3AcosfWtHMsT5JyZudrexyEVzTBWV3viP/YfB9e2pEy3N7WXL3SV6ASXpTU0vzzSxsbfsuUH4sQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="/js/highlight.pack.js" type="application/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
